import{j as e}from"./jsx-runtime.236aeee0.js";import{r as n}from"./index.9e3bb68e.js";import{S as I}from"./SinMensajes.c4b1b56c.js";import{y as A,z as h,A as j,B as w,D as O,G as y}from"./client.595546ea.js";import{N}from"./config.a3d1421f.js";import{B as $}from"./BotonAccion.7f0b3692.js";import{F as _}from"./FlechaIcon.7d235e09.js";import{A as k}from"./_astro-entry_sonner.dae5ec25.js";import{c as S}from"./timeAgo.7aa7f9f1.js";import{A as C}from"./AvatarUser.034f5ec7.js";import"./index.ec3c183f.js";async function E(s){return await A(h(j,"usuarios",s))}function R({usuarioDestino:s,chat:t}){const i=JSON.parse(localStorage.getItem(`${N}-userData`)),[r,u]=n.useState(""),[o,d]=n.useState(!1),l=n.useRef();function p(a){u(a.target.value)}async function m(){if(!r.trim())return k.error("Ingresa un mensaje valido...");const a={text:r,fecha:Date.now(),visto:!1};d(!0);try{await w(h(j,"conversaciones",t.uidCombinado),{messages:O({contenido:{texto:r},fecha:Date.now(),autor:i.uid})}),await w(h(j,"usuarioConversaciones",s.uid),{[t.uidCombinado]:{uidCombinado:t.uidCombinado,uidOtroUsuario:i.uid,uidEmite:i.uid,ultimoMensaje:a}},{merge:!0}),await w(h(j,"usuarioConversaciones",i.uid),{[t.uidCombinado]:{uidCombinado:t.uidCombinado,uidOtroUsuario:s.uid,uidEmite:i.uid,ultimoMensaje:a}},{merge:!0}),u(""),l.current.target.value=""}catch(c){console.log(c)}finally{d(!1)}}return n.useEffect(()=>{u(""),l.current.target&&(l.current.target.value="")},[t]),e.jsxs("div",{className:"mt-3 flex flex-col md:flex-row  gap-2",children:[e.jsx("textarea",{ref:l,value:r,type:"text",placeholder:"Envia un mensaje",className:`block min-h-28  max-h-36 outline-none border resize-none\r
   py-4 px-2  w-full\r
  `,onChange:p}),e.jsxs("button",{disabled:o,onClick:m,className:`border p-1 bg-teal-700 w-10/12 md:w-auto mx-auto md:mx-0 rounded-lg flex justify-center items-center text-white ${o&&"opacity-70"}`,children:[" ",o?e.jsx("div",{class:"container momentun"}):"Enviar"]})]})}function U({msg:s}){const t=JSON.parse(localStorage.getItem(`${N}-userData`)),i=n.useRef();return n.useEffect(()=>{i?.current?.scrollIntoView({behavior:"smooth"})},[]),e.jsxs("div",{ref:i,className:`flex border p-1 justify-between gap-2 ${s.autor.uid===t.uid?"flex-row-reverse":"bg-emerald-100"} `,children:[e.jsxs("div",{className:`flex gap-1 ${s.autor.uid===t.uid?"flex-row-reverse":""}`,children:[e.jsx(C,{user:s.autor}),e.jsx("p",{className:"whitespace-break-spaces text-sm",children:s.contenido.texto})]}),e.jsx("span",{className:"text-[10px] whitespace-nowrap ",children:S(s?.fecha)?.split(" ")?.slice(1)?.join(" ")})]},s.fecha)}function z({chat:s=null,setChatSeleccionado:t,isMovil:i}){const[r,u]=n.useState([]),[o,d]=n.useState(!1),[l,p]=n.useState(null);return n.useEffect(()=>{p(s?.usuario);async function m(){d(!0);const a=y(h(j,"conversaciones",s.uidCombinado),c=>{const v=c.data();if(v){const b=v.messages.map(async f=>{const x=await E(f.autor);return{...f,autor:x.data()}});Promise.all(b).then(f=>{d(!1),u(f)})}},c=>{console.log(c)});return()=>{u([]),a()}}s!==null&&m()},[s]),e.jsx("main",{className:`bg-white  md:flex gap-2  md:min-h-full md:shadow-md rounded-md flex-col p-2
      flex-grow `,children:s===null?e.jsxs("div",{className:"text-center text-xl m-auto",children:[e.jsx("p",{className:"bg-gradient-to-t from-emerald-600 text-transparent bg-clip-text font-semibold",children:s===null?"Inicia una conversación":"Selecciona un chat"}),"👈🏽"]}):e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"border-b p-2 flex justify-between items-center",children:[e.jsx("a",{className:"hover:underline hover:text-sky-600",href:`/perfil/${s?.usuario?.uid}`,children:s?.usuario?.displayName}),i&&e.jsx($,{onClick:()=>{t(null)},children:e.jsx(_,{className:"rotate-90"})})]}),e.jsx("div",{className:"h-full flex flex-col gap-3",children:o?e.jsx("div",{className:"flex justify-center items-start mt-5",children:e.jsxs("div",{className:"container dot_wave",children:[e.jsx("div",{className:"dot"}),e.jsx("div",{className:"dot"}),e.jsx("div",{className:"dot"}),e.jsx("div",{className:"dot"})]})}):r.length>0?e.jsx("div",{className:"flex flex-col gap-1 overflow-y-auto max-h-[600px]",children:r.map(m=>{if(m)return e.jsx(U,{msg:m})})}):e.jsx("p",{children:"No hay mensajes"})}),e.jsx(R,{chat:s,usuarioDestino:l})]})})}function L({conversacion:s,handleChat:t}){const i=JSON.parse(localStorage.getItem(`${N}-userData`));return e.jsx("div",{onClick:()=>{t(s)},className:"border-b border-t p-3 hover:bg-gray-100 transition-all cursor-pointer",children:e.jsxs("div",{className:"flex  gap-3 relative",children:[e.jsx(C,{className:"w-12 h-12",user:s.usuario}),e.jsxs("div",{className:"flex text-xs flex-col gap-1",children:[e.jsxs("div",{className:"flex justify-between gap-5",children:[e.jsxs("p",{className:"font-semibold whitespace-nowrap",children:[" ",s.usuario?.displayName]}),e.jsx("span",{className:"text-xs truncate",children:S(s.ultimoMensaje.fecha)})]}),e.jsxs("p",{className:"truncate text-sm  whitespace-normal",children:[s.uidEmite===i.uid?"Tú: ":e.jsxs("span",{className:"",children:[s.usuario?.displayName.split(" ")[0],":"," "]}),s.ultimoMensaje.text?.slice(0,30)||e.jsx("span",{className:"text-xs ",children:"envia un mensaje"})]})]})]})},s.uidCombinado)}function Q(){const[s,t]=n.useState([]),[i,r]=n.useState(window.innerWidth),[u,o]=n.useState(!1),[d,l]=n.useState(null),p=JSON.parse(localStorage.getItem(`${N}-userData`));n.useEffect(()=>{o(!0);const a=y(h(j,"usuarioConversaciones",p.uid),c=>{const v=c.data();if(v){const f=Object.values(v).map(async x=>{const g=await E(x.uidOtroUsuario);return{...x,usuario:g.data()}});Promise.all(f).then(x=>{const g=x.sort((D,M)=>M.ultimoMensaje.fecha-D.ultimoMensaje.fecha);o(!1),t(g)}).catch(x=>console.log(x)).finally(()=>o(!1))}else o(!1)},c=>{console.log(c)});return()=>{a()}},[]),n.useEffect(()=>{const a=()=>{r(window.innerWidth)};return window.addEventListener("resize",a),()=>{window.removeEventListener("resize",a)}},[]);function m(a){console.log({chat:a}),l(a)}return e.jsxs("div",{className:" w-full relative max-w-4xl mx-auto  flex gap-2",children:[e.jsxs("aside",{className:`w-full min-h-screen md:w-[320px] md:min-h-full flex-shrink-0\r
     bg-white shadow-md rounded-md flex flex-col gap-1 overflow-hidden`,children:[e.jsx("h2",{className:"text-xl text-gray-500 p-3 text-center",children:"Mensajes"}),e.jsx("section",{className:"min-h-[500px] h-[100%] bg-white",children:u?e.jsxs("div",{className:"text-center  flex flex-col items-center justify-center",children:[e.jsxs("div",{className:"loader bouncy",children:[e.jsx("div",{className:"cube",children:e.jsx("div",{className:"cube__inner"})}),e.jsx("div",{className:"cube",children:e.jsx("div",{className:"cube__inner"})}),e.jsx("div",{className:"cube",children:e.jsx("div",{className:"cube__inner"})})]}),e.jsx("p",{className:"text-emerald-700 animate-pulse",children:"Cargando..."})]}):s.length===0?e.jsx(I,{}):s.map(a=>e.jsx(L,{conversacion:a,handleChat:m},a?.usuario?.uid))})]}),e.jsx("div",{className:`${i<768?d===null?"fixed translate-x-[100%]  opacity-0 h-[60%] pointer-events-none duration-75":"fixed translate-x-[0%]  h-[60%] opacity-100 pointer-events-auto":"transition-all"} w-full sm:w-[90%] md:w-full  transition-all flex flex-grow `,children:e.jsx(z,{isMovil:i<768,setChatSeleccionado:l,chat:d})})]})}export{Q as PaginaMensaje};
